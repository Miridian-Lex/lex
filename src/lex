#!/bin/bash
# Meridian Lex - Operational Launcher
# Version: 2.0 - Modular Architecture
# Architecture: Hexagonal (ports and adapters pattern)
# - Core business logic in lex-lib modules
# - Main script handles routing and initialization

set -e

# Determine if we're running from dev or system location
SCRIPT_PATH="$(readlink -f "$0")"
if [[ "$SCRIPT_PATH" == *"/projects/lex/"* ]]; then
    export LEX_DEV_MODE=true
    export LEX_LIB_DIR="$(dirname "$SCRIPT_PATH")/../lib/lex-lib"
else
    export LEX_DEV_MODE=false
    export LEX_LIB_DIR="/home/meridian/meridian-home/projects/lex/lib/lex-lib"
fi

# Source core library (must be first - exports paths and utilities)
source "$LEX_LIB_DIR/core.sh"

# Source other modules
source "$LEX_LIB_DIR/projects.sh"
source "$LEX_LIB_DIR/config.sh"
source "$LEX_LIB_DIR/menu.sh"
source "$LEX_LIB_DIR/agentos.sh"
source "$LEX_LIB_DIR/conversations.sh"

# Initialize Agent OS integration check
check_agentos_available

# Version
export LEX_VERSION="2.0.0"

# Main entry point - command dispatcher
main() {
    # No arguments - show interactive menu
    [ $# -eq 0 ] && { show_menu; return; }

    # Parse flag options first (can be combined with other commands)
    while [[ "$1" == --flags || "$1" == --full-access || "$1" == --preset || "$1" == --no-flags ]]; do
        case "$1" in
            --flags)
                [ -z "$2" ] && { print_error "Flag value required for --flags"; exit 1; }
                export LEX_CLAUDE_FLAGS="$2"
                shift 2
                ;;
            --full-access)
                export LEX_CLAUDE_FLAGS="--dangerously-skip-permissions"
                shift
                ;;
            --preset)
                [ -z "$2" ] && { print_error "Preset name required for --preset"; exit 1; }
                # Get preset from config
                local preset_flags=$($LEX_CONFIG_SH get "claude.presets.$2" 2>/dev/null | tr -d '"')
                if [ -z "$preset_flags" ]; then
                    print_error "Preset not found: $2"
                    echo ""
                    print_info "Available presets:"
                    $LEX_CONFIG_SH get claude.presets 2>/dev/null || echo "  No presets configured"
                    exit 1
                fi
                export LEX_CLAUDE_FLAGS="$preset_flags"
                shift 2
                ;;
            --no-flags)
                export LEX_CLAUDE_FLAGS=""
                shift
                ;;
        esac
    done

    # Parse arguments
    case "$1" in
        # Help and version
        -h|--help) show_usage ;;
        -v|--version) echo "Meridian Lex v$LEX_VERSION" ;;

        # Project operations
        -l|--list) print_header; list_projects ;;
        -g|--global) launch_claude "$LEX_HOME" "Home" ;;
        --god)
            export LEX_CLAUDE_FLAGS="--dangerously-skip-permissions"
            launch_claude "$LEX_HOME" "Home"
            ;;
        -n|--new)
            [ -z "$2" ] && { print_error "Name required"; exit 1; }
            mkdir -p "$PROJECTS_DIR/$2"/{src,tests,docs,.claude}
            cd "$PROJECTS_DIR/$2"; git init
            echo "# $2" > "$PROJECTS_DIR/$2/README.md"
            echo "# Project: $2" > "$PROJECTS_DIR/$2/.claude/CLAUDE.md"
            touch "$PROJECTS_DIR/$2/.gitignore"
            print_success "Created: $2"
            launch_claude "$PROJECTS_DIR/$2" "$2"
            ;;
        -d|--delete)
            [ -z "$2" ] && { print_error "Project name required"; exit 1; }
            local project_path="$PROJECTS_DIR/$2"
            [ ! -d "$project_path" ] && { print_error "Project not found: $2"; exit 1; }
            echo ""
            print_warn "⚠ DESTRUCTIVE OPERATION ⚠"
            echo ""
            echo -e "  Project: ${RED}$2${NC}"
            echo "  Path: $project_path"
            echo ""
            echo "This will permanently delete all files in this project."
            echo ""
            read -p "Type project name to confirm deletion: " confirm
            if [ "$confirm" == "$2" ]; then
                rm -rf "$project_path"
                print_success "Deleted: $2"
            else
                print_error "Deletion cancelled (name mismatch)"
                exit 1
            fi
            ;;

        # Information display
        -m|--map) cat "$PROJECT_MAP" ;;
        -s|--state) cat "$STATE_FILE" ;;
        -t|--tasks) cat "$TASK_QUEUE" ;;

        # Configuration management
        --config) $LEX_CONFIG_SH show ;;
        --mode)
            if [ -z "$2" ]; then
                $LEX_MODE_SH get
            else
                $LEX_MODE_SH set "$2"
            fi
            ;;
        --tokens) $LEX_CONFIG_SH tokens ;;
        --check-auto) $CHECK_AUTO_SH ;;

        # System operations
        --dev-mode) toggle_dev_mode ;;

        # Agent OS Integration
        --agentos-setup)
            if [ "$AGENTOS_AVAILABLE" = true ]; then
                print_info "Agent OS integration already available"
                exit 0
            fi
            setup_agentos_project
            ;;
        --agentos-init)
            if [ "$AGENTOS_AVAILABLE" != true ]; then
                print_error "Agent OS integration not available"
                echo ""
                print_info "Run 'lex --agentos-setup' to enable Agent OS features"
                exit 1
            fi
            if [ -n "$2" ] && [ -d "$PROJECTS_DIR/$2" ]; then
                cd "$PROJECTS_DIR/$2"
                agentos_init_current_project "$3"
            else
                agentos_init_current_project "$2"
            fi
            ;;
        --agentos-status)
            if [ "$AGENTOS_AVAILABLE" != true ]; then
                print_error "Agent OS integration not available"
                echo ""
                print_info "Run 'lex --agentos-setup' to enable Agent OS features"
                exit 1
            fi
            if [ -n "$2" ] && [ -d "$PROJECTS_DIR/$2" ]; then
                agentos_status "$PROJECTS_DIR/$2"
            else
                agentos_status "${2:-.}"
            fi
            ;;
        --agentos-verify)
            if [ "$AGENTOS_AVAILABLE" != true ]; then
                print_error "Agent OS integration not available"
                echo ""
                print_info "Run 'lex --agentos-setup' to enable Agent OS features"
                exit 1
            fi
            if [ -n "$2" ] && [ -d "$PROJECTS_DIR/$2" ]; then
                agentos_verify "$PROJECTS_DIR/$2"
            else
                agentos_verify "$2"
            fi
            ;;
        --agentos-install-base)
            if [ "$AGENTOS_AVAILABLE" != true ]; then
                print_error "Agent OS integration not available"
                echo ""
                print_info "Run 'lex --agentos-setup' to enable Agent OS features"
                exit 1
            fi
            agentos_install_base
            ;;
        --agentos-update)
            if [ "$AGENTOS_AVAILABLE" != true ]; then
                print_error "Agent OS integration not available"
                echo ""
                print_info "Run 'lex --agentos-setup' to enable Agent OS features"
                exit 1
            fi
            agentos_update_base
            ;;

        # Conversation management
        --continue)
            [ -z "$2" ] && { print_error "Project name required"; exit 1; }
            [ ! -d "$PROJECTS_DIR/$2" ] && { print_error "Project not found: $2"; exit 1; }
            export LEX_CURRENT_PROJECT="$2"
            launch_claude_continue "$PROJECTS_DIR/$2" "$2"
            ;;
        --resume-picker)
            [ -z "$2" ] && { print_error "Project name required"; exit 1; }
            [ ! -d "$PROJECTS_DIR/$2" ] && { print_error "Project not found: $2"; exit 1; }
            export LEX_CURRENT_PROJECT="$2"
            launch_claude_resume_picker "$PROJECTS_DIR/$2" "$2"
            ;;
        --new-conversation)
            [ -z "$2" ] && { print_error "Project name required"; exit 1; }
            [ ! -d "$PROJECTS_DIR/$2" ] && { print_error "Project not found: $2"; exit 1; }
            export LEX_CURRENT_PROJECT="$2"
            launch_claude_new "$PROJECTS_DIR/$2" "$2"
            ;;

        # Project launch (by name) - uses smart_launch
        *)
            [ ! -d "$PROJECTS_DIR/$1" ] && { print_error "Not found: $1"; list_projects; exit 1; }
            export LEX_CURRENT_PROJECT="$1"
            smart_launch "$PROJECTS_DIR/$1" "$1"
            ;;
    esac
}

main "$@"
